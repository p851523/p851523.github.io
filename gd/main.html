<!DOCTYPE html>
<html style="height: 100%;">
	<head>
		<title>gd</title>
	</head>
	<body oncontextmenu="return false" style="margin: 0px; height: 100%; overflow: hidden; background-color: #222; user-select: none">
		<style>
			img {
				display: none
			}
		</style>
		<img crossorigin="anonymous" src="assets/gs.png">
		<img crossorigin="anonymous" src="assets/ls.png">
		<img crossorigin="anonymous" src="assets/gl.png">
		<img crossorigin="anonymous" src="assets/fl.png">
		<img crossorigin="anonymous" src="assets/bg/0.png">
		<img crossorigin="anonymous" src="assets/grnd/0.png">
		
		<div style="width: 100%; height: 100%; display: flex; justify-content: center">
			<canvas id="canvas" width="2160" height="720" style="aspect-ratio: 3 / 1; height: 100%/*; image-rendering: pixelated*/"></canvas>
		</div>
		<script>
			window.addEventListener("load", function () { setTimeout(function () {
				//player can see 12 blocks in height, 1 block is 60x60 px
				
				var mousedown = false;
				document.addEventListener("mousedown", function (e) {
					if (e.button == 0) { //if its leftclick
						mousedown = true;
					}
				});
				document.addEventListener("mouseup", function (e) {
					if (e.button == 0) { //if its leftclick
						mousedown = false;
					}
				});
				
				function tint(img, col) {
					let ofc = new OffscreenCanvas(img.width, img.height);
					let ofx = ofc.getContext("2d");
					ofx.filter = "invert(1)";
					ofx.drawImage(img, 0, 0);
					ofx.globalCompositeOperation = "lighter";
					ofx.fillStyle = col;
					ofx.fillRect(0, 0, img.width, img.height);
					let ofc2 = new OffscreenCanvas(img.width, img.height);
					let ofx2 = ofc2.getContext("2d");
					ofx2.drawImage(img, 0, 0);
					ofx2.globalCompositeOperation = "source-in";
					ofx2.filter = "invert(1) brightness(1.1)";
					ofx2.drawImage(ofc, 0, 0);
					return ofc2;
				};
				
				function clamp(num, min, max) {
					return (num > max) ? (max) : ((min > num) ? (min) : (num));
				};
				
				const imgs = document.getElementsByTagName("img");
				const canv = document.getElementById("canvas").getContext("2d");
				
				
				var cam = {x: 0, y: 0};
				var lvl = [{x: 0, y: 0},{x: 1, y: 2}];
				var colors = {bg: '#0099FF', grnd: '#0055BB', dbg: '', dgrnd: '', bgimg: '', grndimg: ''};
				var player = {x: -1024, y: 0, xs: 10, ys: 0, r: 0, rs: 0, ground: false, grav: -3, img1: tint(imgs[0], '#00FF00'), img2: tint(imgs[0], '#00FFFF')};
				
				
				
				
				
				setInterval(function () {
					player.ys += player.grav;
					
					if (mousedown && player.ground) {
						player.ys = 30;
					};
					
					player.x += player.xs;
					
					if (player.ys != 0) {
						var sd = player.ys / Math.abs(player.ys);
						player.ground = false;
						for (let i = 0; i <= Math.abs(player.ys); i++) {
							if (player.y + sd > 0) {
								player.y += sd;
								player.rs += 0.1;
							} else {
								player.ys = 0;
								player.ground = true;
								player.rs = 0;
								player.r = Math.floor(player.r / 90);
								break;
							};
						};
					};
					
					player.rs = clamp(player.rs, -7, 7);
					player.r += player.rs;
					player.r %= 360;
					
					cam.x = player.x - 780;
					cam.y = player.y + 542;
					
					
					//draw bg
					if (colors.bg != colors.dbg) {
						colors.bgimg = tint(imgs[4], colors.bg);
						colors.dbg = colors.bg;
					};
					for (let i = 0; i < 3; i++) {
						canv.drawImage(colors.bgimg, i * 1536 - ((cam.x / 5) % 1536) - 1024, cam.y / 5 - 950, 1536, 1536);
					};
					
					//draw level
					//canv.globalCompositeOperation = "lighter"; //blending
					for (let i of lvl) {
						canv.drawImage(imgs[0], 0, 0, 60, 60, i.x * 60 - cam.x, cam.y - i.y * 60 - 60, 60, 60);
					};
					
					//draw player
					canv.translate(player.x - cam.x + 30, cam.y - player.y - 60 + 30);
					canv.rotate(player.r * Math.PI / 180);
					canv.translate(-(player.x - cam.x + 30), -(cam.y - player.y - 60 + 30));
					
					canv.drawImage(player.img2, 900, 420, 60, 60, player.x - cam.x, cam.y - player.y - 60, 60, 60);
					canv.drawImage(player.img1, 900, 360, 60, 60, player.x - cam.x, cam.y - player.y - 60, 60, 60);
					
					canv.setTransform(1, 0, 0, 1, 0, 0);
					
					//draw grnd
					if (colors.grnd != colors.dgrnd) {
						colors.grndimg = tint(imgs[5], colors.grnd);
						colors.dgrnd = colors.grnd;
					};
					for (let i = -1; i < 10; i++) {
						canv.drawImage(colors.grndimg, i * 256 - (cam.x % 256), cam.y, 256, 256);
					};
					
					//draw grnd line
					canv.drawImage(imgs[3], 492, cam.y, 392*3, 1*3);
				}, 33)
			}, 1000); });
		</script>
	</body>
</html>
